<!DOCTYPE html>
<html lang="es" class="h-100">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aceitera - Productos</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
</head>
<body class="d-flex flex-column h-100">
    <main class="flex-shrink-0">
        <div class="container">
            <h3 class="my-3">Lista de Productos</h3>
            <!-- Tabla de Productos -->
            <table class="table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Nombre</th>
                        <th>Precio</th>
                        <th>Cantidad</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="product-list">
                    <!-- Productos serán añadidos aquí por JavaScript -->
                </tbody>
            </table>
            <div class="col-12">
                <a href="nuevo.html" class="btn btn-primary my-3">Agregar Nuevo Producto</a>
            </div>
        </div>
    </main>

    <script>
        // Función para cargar productos desde el servidor
        async function cargarProductos() {
            const container = document.getElementById('product-list');
            container.innerHTML = ''; // Limpiar la tabla
    
            try {
                const response = await fetch('http://localhost:3000/productos');
                const productos = await response.json();
    
                productos.forEach((producto) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${producto.id}</td>
                        <td>${producto.nombre}</td>
                        <td>${producto.precio}</td>
                        <td>${producto.cantidad}</td>
                        <td>
                            <button onclick="eliminarProducto(${producto.id})" class="btn btn-danger btn-sm">Eliminar</button>
                        </td>
                    `;
                    container.appendChild(row);
                });
            } catch (error) {
                console.error('Error al cargar productos:', error);
            }
        }
    
        // Comprobar si se necesita recargar la lista al abrir index.html
        if (localStorage.getItem('reload') === 'true') {
            localStorage.removeItem('reload'); // Limpiar la señal antes de recargar
            cargarProductos();
        } else {
            cargarProductos(); // Cargar productos normalmente
        }
    
        // Función para eliminar un producto
        async function eliminarProducto(id) {
            if (confirm('¿Estás seguro de eliminar este producto?')) {
                try {
                    await fetch(`http://localhost:3000/productos/${id}`, {
                        method: 'DELETE'
                    });
                    alert('Producto eliminado');
                    cargarProductos(); // Recargar la lista
                } catch (error) {
                    console.error('Error al eliminar producto:', error);
                }
            }
        }
        // Ruta POST para registrar una venta
app.post('/ventas', async (req, res) => {
    const { productoId, cantidad } = req.body;

    try {
        // Obtener el producto
        const { data: producto, error: fetchError } = await supabase
            .from('productos')
            .select('*')
            .eq('id', productoId)
            .single();

        if (fetchError || !producto) throw new Error('Producto no encontrado');
        if (producto.cantidad < cantidad) throw new Error('Stock insuficiente');

        // Actualizar el stock
        const { error: updateError } = await supabase
            .from('productos')
            .update({ cantidad: producto.cantidad - cantidad })
            .eq('id', productoId);

        if (updateError) throw updateError;

        // Registrar la venta
        const { error: insertError } = await supabase
            .from('ventas')
            .insert([{ productoId, cantidad, fecha: new Date().toISOString() }]);

        if (insertError) throw insertError;

        res.status(201).json({ message: 'Venta registrada' });
    } catch (error) {
        console.error('Error al registrar venta:', error.message);
        res.status(400).json({ error: error.message });
    }
});

    </script>
    
</body>
</html>
