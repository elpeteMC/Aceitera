<!DOCTYPE html>
<html lang="es" class="h-100">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aceitera - Registrar Venta</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
</head>
<body class="d-flex flex-column h-100">
    <header class="bg-primary text-white text-center py-3">
        <h1>Aceitera - Registrar Venta</h1>
    </header>
    <main class="flex-shrink-0">
        <div class="container mt-4">
            <h3 class="mb-4">Nueva Venta</h3>
            <form id="venta-form" class="needs-validation" novalidate>
                <div class="mb-3">
                    <label for="productoid" class="form-label">ID del Producto</label>
                    <input type="number" id="productoid" class="form-control" required>
                    <div class="invalid-feedback">Por favor, ingresa el ID del producto.</div>
                </div>
                <div class="mb-3">
                    <label for="cantidad" class="form-label">Cantidad Vendida</label>
                    <input type="number" id="cantidad" class="form-control" min="1" required>
                    <div class="invalid-feedback">Por favor, ingresa una cantidad válida.</div>
                </div>
                <div class="d-flex justify-content-between">
                    <a href="index.html" class="btn btn-secondary">Cancelar</a>
                    <button type="submit" class="btn btn-primary">Registrar Venta</button>
                </div>
            </form>
        </div>
    </main>
    <footer class="mt-auto bg-light text-center py-3">
        <small>Sistema de Gestión de Aceitera &copy; 2024</small>
    </footer>

    <script>
        // Validación del formulario
        (() => {
            const form = document.getElementById('venta-form');
            form.addEventListener('submit', async (event) => {
                event.preventDefault(); // Evita el envío predeterminado
                event.stopPropagation();

                if (form.checkValidity()) {
                    // Llamar a la función para registrar venta
                    await registrarVenta();
                }

                form.classList.add('was-validated');
            });
        })();

        // Función para registrar una nueva venta
        async function registrarVenta() {
            const productoid = parseInt(document.getElementById('productoid').value, 10);
            const cantidad_vendida = parseInt(document.getElementById('cantidad').value, 10);

            // Validación adicional (opcional)
            if (!productoid || cantidad_vendida <= 0) {
                alert('Por favor, completa todos los campos correctamente.');
                return;
            }

            try {
                const response = await fetch('https://aceitera.onrender.com/ventas', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ productoid, cantidad_vendida }),
                });

                if (!response.ok) throw new Error('Error al registrar la venta.');

                alert('Venta registrada con éxito.');
                window.location.href = 'ventas.html'; // Redirigir al listado de ventas
            } catch (error) {
                console.error('Error al registrar la venta:', error);
                alert('No se pudo registrar la venta. Intenta de nuevo más tarde.');
            }
        }
    </script>
</body>
</html>
